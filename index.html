<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·ç®¡ç†åŠ©æ‰‹ (ä¿®å¤ç‰ˆ)</title>
    <style>
        :root {
            --primary: #07c160;
            --blue: #2196F3;
            --bg: #F2F3F5;
            --text-main: #333;
            --card-bg: #fff;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: var(--text-main);
            min-height: 100vh;
            /* å±…ä¸­æ˜¾ç¤ºï¼Œé˜²æ­¢åœ¨ç”µè„‘ä¸Šå¤ªå®½ */
            display: flex; justify-content: center;
        }

        /* æ‰‹æœºå°ºå¯¸å®¹å™¨é™åˆ¶ */
        .app-container {
            width: 100%;
            max-width: 480px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼ŒåƒAppä¸€æ · */
            background: #f7f8fa;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- é¡µé¢ 1ï¼šè®¾ç½®é¡µ --- */
        #setup-page {
            display: flex; flex-direction: column; justify-content: center;
            min-height: 100vh; padding: 25px; box-sizing: border-box; background: #fff;
        }
        .welcome-title { font-size: 26px; font-weight: 800; text-align: center; margin-bottom: 10px; color: #333; }
        .welcome-sub { text-align: center; color: #999; margin-bottom: 30px; font-size: 14px; }

        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #555; }
        input, select {
            width: 100%; padding: 14px; margin-bottom: 20px;
            border: 1px solid #eee; border-radius: 12px;
            background: #f9f9f9; font-size: 16px; box-sizing: border-box;
            appearance: none; /* å»é™¤åŸç”Ÿæ ·å¼ */
        }
        input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3); }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        /* --- é¡µé¢ 2ï¼šä¸»ç•Œé¢ --- */
        #main-page { display: none; padding: 15px; padding-bottom: 60px; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .user-info b { font-size: 18px; color: var(--primary); }
        .edit-btn { background: #e0e0e0; padding: 6px 15px; border-radius: 20px; font-size: 13px; border: none; font-weight: bold; color: #555; cursor: pointer;}

        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        h2 { margin: 0 0 15px 0; font-size: 17px; font-weight: 700; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* ä»ªè¡¨ç›˜ */
        .dashboard-grid { display: flex; gap: 12px; margin-bottom: 15px; }
        .stat-card { flex: 1; background: #fff; padding: 20px 15px; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .stat-num { font-size: 28px; font-weight: 800; display: block; margin-bottom: 5px; line-height: 1; }
        .stat-label { font-size: 13px; color: #999; }
        
        .progress-box { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; transition: width 0.5s; border-radius: 4px; }

        /* å–æ°´ */
        .water-row { display: flex; align-items: center; justify-content: space-between; }
        .water-btn-small { background: #e3f2fd; color: var(--blue); border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; }

        /* æ™ºèƒ½æç¤º */
        .smart-hint { 
            font-size: 13px; color: var(--primary); 
            background: #e8f5e9; padding: 8px; 
            border-radius: 8px; display: none; margin-bottom: 15px; 
        }

        /* åˆ—è¡¨ */
        .food-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px dashed #eee; font-size: 16px; align-items: center; }
        .del-icon { color: #ccc; padding: 5px 10px; font-size: 20px; cursor: pointer; }
        
        .ai-box { background: #fffbe6; padding: 12px; border-radius: 8px; font-size: 14px; color: #856404; margin-bottom: 15px; display: none; line-height: 1.5; border: 1px solid #ffe58f; }

        /* optgroup æ ·å¼ */
        optgroup { font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- ğŸŸ¡ é¡µé¢ 1ï¼šè®¾ç½®/å¼•å¯¼é¡µ -->
    <div id="setup-page">
        <div class="welcome-title">ğŸ‘‹ æ¬¢è¿å›æ¥</div>
        <div class="welcome-sub">å¡«å†™æ•°æ®ï¼Œä¸ºä½ å®šåˆ¶ä¸“å±çƒ­é‡ç›®æ ‡</div>
        
        <label>èº«é«˜ (cm)</label>
        <input type="number" id="height" placeholder="ä¾‹å¦‚: 175">

        <label>ä½“é‡ (kg)</label>
        <input type="number" id="weight" placeholder="ä¾‹å¦‚: 70">

        <div style="display: flex; gap:15px;">
            <div style="flex:1">
                <label>å¹´é¾„</label>
                <input type="number" id="age" placeholder="25">
            </div>
            <div style="flex:1">
                <label>æ€§åˆ«</label>
                <select id="gender">
                    <option value="male">ç”·</option>
                    <option value="female">å¥³</option>
                </select>
            </div>
        </div>

        <label>ç›®æ ‡</label>
        <select id="goal">
            <option value="0">âš–ï¸ ä¿æŒä½“é‡</option>
            <option value="-300">ğŸ“‰ å‡è„‚ (-300)</option>
            <option value="-500">ğŸ”¥ å¿«é€Ÿå‡è„‚ (-500)</option>
            <option value="300">ğŸ’ª å¢è‚Œ (+300)</option>
        </select>
        
        <label>æ—¥å¸¸æ´»åŠ¨é‡</label>
        <select id="activity">
            <option value="1.2">ğŸ˜´ ä¹…åä¸åŠ¨ (åŠå…¬å®¤)</option>
            <option value="1.375">ğŸš¶ è½»åº¦è¿åŠ¨ (æ¯å‘¨1-3æ¬¡)</option>
            <option value="1.55">ğŸƒ ä¸­åº¦è¿åŠ¨ (æ¯å‘¨3-5æ¬¡)</option>
        </select>

        <button class="btn btn-primary" onclick="finishSetup()">è¿›å…¥ä¸»é¡µ</button>
    </div>

    <!-- ğŸŸ¢ é¡µé¢ 2ï¼šä¸»ç•Œé¢ -->
    <div id="main-page">
        <div class="top-bar">
            <div class="user-info">BMI: <b id="show-bmi">--</b> <span id="bmi-tag" style="font-size:12px; background:#eee; padding:2px 6px; border-radius:4px; color:#666;">--</span></div>
            <button class="edit-btn" onclick="goToSetup()">âš™ï¸ è®¾ç½®æ•°æ®</button>
        </div>

        <!-- ä»ªè¡¨ç›˜ -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="stat-label">ğŸ”¥ è¿˜èƒ½åƒ</span>
                <span class="stat-num" id="val-remaining" style="color:var(--primary)">0</span>
                <div class="progress-box">
                    <div id="bar-cal" class="progress-bar" style="width:0%; background:var(--primary)"></div>
                </div>
            </div>
            <div class="stat-card">
                <span class="stat-label">ğŸ’§ å·²å–æ°´</span>
                <span class="stat-num" id="val-water" style="color:var(--blue)">0</span>
                <div class="progress-box">
                    <div id="bar-water" class="progress-bar" style="width:0%; background:var(--blue)"></div>
                </div>
            </div>
        </div>

        <!-- è¡¥æ°´æŒ‰é’® -->
        <div class="card water-row">
            <span style="font-weight:bold; color:#555;">ğŸ’§ è¡¥æ°´ç«™</span>
            <div style="display:flex; gap:10px;">
                <button class="water-btn-small" onclick="addWater(200)">+200ml</button>
                <button class="water-btn-small" style="background:#bbdefb; color:#0d47a1" onclick="addWater(500)">+500ml</button>
            </div>
        </div>

        <!-- é¥®é£Ÿè®°å½• -->
        <div class="card">
            <h2>ğŸ¥˜ é¥®é£Ÿè®°å½•</h2>
            
            <select id="quick-food" onchange="fillFromTemplate()" style="margin-bottom:10px; color:#555;">
                <option value="">âš¡ï¸ å¿«é€Ÿé€‰æ‹©å¸¸è§é£Ÿç‰©...</option>
                <optgroup label="ğŸš ä¸»é£Ÿ/æ—©é¤">
                    <option value="ç±³é¥­:230">ç±³é¥­ (1ç¢—)</option>
                    <option value="ç›–æµ‡é¥­:750">ç›–æµ‡é¥­ (1ä»½)</option>
                    <option value="è‚‰åŒ…å­:250">è‚‰åŒ…å­ (1ä¸ª)</option>
                    <option value="ç‡•éº¦ç‰‡:150">ç‡•éº¦ç‰‡ (1ç¢—)</option>
                </optgroup>
                <optgroup label="ğŸ¥¤ é¥®æ–™/å’–å•¡">
                    <option value="å¯ä¹:140">å¯ä¹ (1å¬)</option>
                    <option value="æ‹¿é“:200">æ‹¿é“å’–å•¡</option>
                    <option value="ç¾å¼:15">ç¾å¼å’–å•¡</option>
                </optgroup>
                <optgroup label="ğŸ– è›‹ç™½è´¨/è‚‰ç±»">
                    <option value="é¸¡è›‹:80">æ°´ç…®è›‹ (1ä¸ª)</option>
                    <option value="é¸¡èƒ¸è‚‰:130">é¸¡èƒ¸è‚‰ (100g)</option>
                    <option value="ç‰›æ’:300">ç‰›æ’ (1ä»½)</option>
                </optgroup>
            </select>

            <input type="text" id="food-name" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥ (å¦‚: ç‚¸é¸¡)" oninput="autoMatch()">
            
            <div id="smart-hint" class="smart-hint"></div>

            <div style="display:flex; gap:10px;">
                <input type="number" id="food-cal" placeholder="çƒ­é‡ (kcal)" style="margin-bottom:0;">
                <button class="btn btn-primary" style="width:100px; padding:0; margin:0;" onclick="addFood()">è®°å½•</button>
            </div>
        </div>

        <!-- AI å»ºè®® -->
        <div id="ai-advice" class="ai-box"></div>

        <!-- åˆ—è¡¨ -->
        <div class="card">
            <h2>ğŸ“ ä»Šæ—¥æ¸…å•</h2>
            <div id="food-list"></div>
            <div style="text-align:center; margin-top:15px;">
                <span onclick="clearDay()" style="color:#999; font-size:13px; text-decoration:underline; cursor:pointer;">æ¸…ç©ºä»Šæ—¥è®°å½•</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å…¨å±€å˜é‡ ---
    let user = { height: '', weight: '', age: '', gender: 'male', activity: 1.2, goal: 0 };
    let data = { consumed: 0, water: 0, foods: [] };

    // --- æ•°æ®åº“ ---
    const foodDB = {
        "ç±³é¥­": 230, "ç›–é¥­": 750, "ç‚’é¥­": 700, "é¢": 400, "ç²‰": 450,
        "é¸¡è›‹": 80, "é¸¡èƒ¸": 130, "ç‰›è‚‰": 200, "çŒªè‚‰": 300, "é±¼": 120,
        "è‹¹æœ": 50, "é¦™è•‰": 90, "è¥¿ç“œ": 40, "è‘¡è„": 60,
        "å¯ä¹": 140, "é›ªç¢§": 150, "å¥¶èŒ¶": 450, "æ‹¿é“": 200, "ç¾å¼": 15,
        "æ±‰å ¡": 550, "è–¯æ¡": 350, "ç‚¸é¸¡": 600, "ç«é”…": 1000, "éº»è¾£çƒ«": 600
    };

    const aiRules = [
        { key: "ç‚¸", text: "ğŸš« ç‚¸ç‰©çƒ­é‡è¶…é«˜ï¼Œå»ºè®®è¿™é¡¿ä¹‹ååƒæ¸…æ·¡ç‚¹ã€‚" },
        { key: "ç³–", text: "âš ï¸ ç³–åˆ†ä¼šå¼•èµ·èƒ°å²›ç´ æ³¢åŠ¨ï¼Œå®¹æ˜“å›¤ç§¯è„‚è‚ªã€‚" },
        { key: "å¥¶èŒ¶", text: "âš ï¸ ä¸€æ¯å¥¶èŒ¶ = è·‘æ­¥5å…¬é‡Œï¼Œå»ºè®®å–æ— ç³–çš„ã€‚" },
        { key: "é¸¡èƒ¸", text: "âœ… ä¼˜è´¨è›‹ç™½ï¼Œå¢è‚Œå‡è„‚ç¥å™¨ï¼" },
        { key: "è”¬èœ", text: "âœ… å¤šåƒè”¬èœå¢åŠ é¥±è…¹æ„Ÿï¼Œå¾ˆæ£’ï¼" },
        { key: "å¯ä¹", text: "âš ï¸ æ¶²ä½“ç³–æœ€å®¹æ˜“èƒ–ï¼Œæ¢æˆé›¶åº¦å¯ä¹æ›´å¥½ã€‚" }
    ];

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        try {
            const u = localStorage.getItem('fit_user_v7');
            const d = localStorage.getItem('fit_data_v7');
            if(u) user = JSON.parse(u);
            if(d) data = JSON.parse(d);

            // æ£€æŸ¥æ˜¯å¦æœ‰èº«é«˜ä½“é‡ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿›ä¸»é¡µ
            if(user.weight && user.height) {
                showMainPage();
            } else {
                goToSetup();
            }
        } catch(e) {
            console.error("åŠ è½½æ•°æ®å‡ºé”™", e);
            goToSetup();
        }
    }

    // --- æµç¨‹æ§åˆ¶ ---
    function goToSetup() {
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('setup-page').style.display = 'flex';
        // å›å¡«æ•°æ®
        if(user.height) document.getElementById('height').value = user.height;
        if(user.weight) document.getElementById('weight').value = user.weight;
        if(user.age) document.getElementById('age').value = user.age;
    }

    // ğŸ”´ æ ¸å¿ƒï¼šç‚¹å‡»â€œè¿›å…¥ä¸»é¡µâ€æŒ‰é’®
    function finishSetup() {
        try {
            const h = document.getElementById('height').value;
            const w = document.getElementById('weight').value;
            const a = document.getElementById('age').value;
            
            if(!h || !w) {
                alert("è¯·è¾“å…¥èº«é«˜å’Œä½“é‡ï¼Œè¿™æ˜¯è®¡ç®—çƒ­é‡çš„åŸºç¡€å“¦ï¼");
                return;
            }

            // ä¿å­˜æ•°æ®
            user.height = h;
            user.weight = w;
            user.age = a;
            user.gender = document.getElementById('gender').value;
            user.activity = document.getElementById('activity').value;
            user.goal = document.getElementById('goal').value;

            saveData();
            showMainPage();

        } catch(e) {
            alert("å‘ç”Ÿé”™è¯¯: " + e.message);
        }
    }

    function showMainPage() {
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
        updateUI();
        window.scrollTo(0, 0);
    }

    // --- ä¸šåŠ¡åŠŸèƒ½ ---
    function fillFromTemplate() {
        const val = document.getElementById('quick-food').value;
        if(val) {
            const parts = val.split(':');
            document.getElementById('food-name').value = parts[0];
            document.getElementById('food-cal').value = parts[1];
            document.getElementById('smart-hint').style.display = 'none';
        }
    }

    function autoMatch() {
        const val = document.getElementById('food-name').value;
        const hintBox = document.getElementById('smart-hint');
        const calInput = document.getElementById('food-cal');
        
        if(!val) { hintBox.style.display = 'none'; return; }

        let found = false;
        for(let key in foodDB) {
            if(val.includes(key)) {
                hintBox.innerHTML = `ğŸ’¡ è¯†åˆ«åˆ° <b>${key}</b>ï¼Œé¢„ä¼° <b>${foodDB[key]}</b> kcal`;
                hintBox.style.display = 'block';
                if(!calInput.value) calInput.value = foodDB[key];
                found = true;
                break;
            }
        }
        if(!found) hintBox.style.display = 'none';
    }

    function addFood() {
        const name = document.getElementById('food-name').value;
        const cal = parseInt(document.getElementById('food-cal').value);
        
        if(!name || isNaN(cal)) {
            alert("è¯·å¡«å†™é£Ÿç‰©åç§°å’Œçƒ­é‡");
            return;
        }

        data.consumed += cal;
        data.foods.unshift({ id: Date.now(), name, cal });
        
        // AI å»ºè®®
        let advice = "";
        for(let rule of aiRules) {
            if(name.includes(rule.key)) { advice = rule.text; break; }
        }
        if(!advice) {
            if(cal > 600) advice = "âš ï¸ è¿™é¡¿çƒ­é‡è¾ƒé«˜ï¼Œæ³¨æ„å…¨å¤©æ§åˆ¶ã€‚";
            else advice = "âœ… å·²è®°å½•ï¼Œç»§ç»­ä¿æŒã€‚";
        }
        const box = document.getElementById('ai-advice');
        box.innerText = advice;
        box.style.display = 'block';

        // æ¸…ç†
        document.getElementById('food-name').value = '';
        document.getElementById('food-cal').value = '';
        document.getElementById('smart-hint').style.display = 'none';
        document.getElementById('quick-food').value = "";

        saveData();
        updateUI();
    }

    function addWater(ml) {
        data.water += ml;
        saveData();
        updateUI();
    }

    function removeFood(id) {
        const idx = data.foods.findIndex(f => f.id === id);
        if(idx > -1) {
            data.consumed -= data.foods[idx].cal;
            data.foods.splice(idx, 1);
            saveData();
            updateUI();
        }
    }

    function clearDay() {
        if(confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©æ‰€æœ‰è®°å½•ï¼Ÿ")) {
            data.consumed = 0; data.water = 0; data.foods = [];
            saveData(); updateUI();
            document.getElementById('ai-advice').style.display = 'none';
        }
    }

    // --- ç•Œé¢æ›´æ–°ä¸å­˜å‚¨ ---
    function updateUI() {
        const h = parseInt(user.height);
        const w = parseInt(user.weight);
        const a = parseInt(user.age) || 25;
        
        // è®¡ç®—æŒ‡æ ‡
        const bmi = (w/((h/100)*(h/100))).toFixed(1);
        let bmiStatus = "æ­£å¸¸";
        if(bmi < 18.5) bmiStatus = "åç˜¦";
        if(bmi >= 24) bmiStatus = "è¶…é‡";
        
        let bmr = (10*w + 6.25*h - 5*a) + (user.gender==='male'?5:-161);
        const target = Math.round(bmr * user.activity) + parseInt(user.goal);
        const waterTarget = w * 35;

        // æ›´æ–°å¤´éƒ¨
        document.getElementById('show-bmi').innerText = bmi;
        document.getElementById('bmi-tag').innerText = bmiStatus;

        // æ›´æ–°çƒ­é‡æ¡
        const remaining = target - data.consumed;
        document.getElementById('val-remaining').innerText = remaining;
        document.getElementById('val-remaining').style.color = remaining < 0 ? '#f44336' : '#07c160';
        
        const calPct = Math.min((data.consumed/target)*100, 100);
        document.getElementById('bar-cal').style.width = calPct + '%';
        document.getElementById('bar-cal').style.background = remaining < 0 ? '#f44336' : '#07c160';

        // æ›´æ–°æ°´æ¡
        document.getElementById('val-water').innerText = data.water;
        const waterPct = Math.min((data.water/waterTarget)*100, 100);
        document.getElementById('bar-water').style.width = waterPct + '%';

        // æ›´æ–°åˆ—è¡¨
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        data.foods.forEach(f => {
            list.innerHTML += `
                <div class="food-item">
                    <span>${f.name}</span>
                    <div style="display:flex; align-items:center">
                        <strong>${f.cal}</strong>
                        <span class="del-icon" onclick="removeFood(${f.id})">Ã—</span>
                    </div>
                </div>`;
        });
    }

    function saveData() {
        localStorage.setItem('fit_user_v7', JSON.stringify(user));
        localStorage.setItem('fit_data_v7', JSON.stringify(data));
    }
</script>
</body>
</html>