<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥çƒ­é‡è®°å½• (ä¿®å¤ç‰ˆ)</title>
    <style>
        :root { --primary: #07c160; --bg: #f5f5f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { font-size: 18px; margin: 0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        input, select { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; font-size: 16px; }
        
        .btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        
        /* ä»ªè¡¨ç›˜ */
        .dashboard { display: flex; justify-content: space-between; text-align: center; margin-bottom: 15px; }
        .num { font-size: 24px; font-weight: bold; display: block; }
        .desc { font-size: 12px; color: #999; }
        
        /* åˆ—è¡¨ */
        .list-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; align-items: center; }
        .del-btn { color: #ccc; padding: 5px 10px; cursor: pointer; }
        
        .hint { color: var(--primary); font-size: 12px; margin-top: 5px; min-height: 18px;}
    </style>
</head>
<body>

    <!-- èº«ä½“æ•°æ®è®¾ç½® -->
    <div class="card">
        <h2>1. èº«ä½“è®¾ç½® (è‡ªåŠ¨ä¿å­˜)</h2>
        <div class="input-group">
            <label>èº«é«˜ (cm) / ä½“é‡ (kg) / å¹´é¾„</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="height" placeholder="èº«é«˜" onchange="saveProfile()">
                <input type="number" id="weight" placeholder="ä½“é‡" onchange="saveProfile()">
                <input type="number" id="age" placeholder="å¹´é¾„" onchange="saveProfile()">
            </div>
        </div>
        <div class="input-group">
            <label>ç›®æ ‡è®¾å®š</label>
            <select id="goal" onchange="saveProfile()">
                <option value="0">ä¿æŒä½“é‡</option>
                <option value="-300">å‡è„‚ (-300å¤§å¡)</option>
                <option value="-500">å¿«é€Ÿå‡è„‚ (-500å¤§å¡)</option>
                <option value="300">å¢è‚Œ (+300å¤§å¡)</option>
            </select>
        </div>
        <div style="text-align:center; font-size:14px; color:#888;">
            ä½ çš„ç›®æ ‡æ‘„å…¥: <span id="target-display" style="color:#07c160; font-weight:bold;">0</span> kcal
        </div>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div class="card">
        <div class="dashboard">
            <div><span class="num" id="show-consumed">0</span><span class="desc">å·²åƒ</span></div>
            <div><span class="num" id="show-remaining" style="color:#07c160">0</span><span class="desc">è¿˜èƒ½åƒ</span></div>
        </div>
        <div style="height:10px; background:#eee; border-radius:5px; overflow:hidden;">
            <div id="progress-bar" style="height:100%; background:#07c160; width:0%;"></div>
        </div>
    </div>

    <!-- è®°è´¦ -->
    <div class="card">
        <h2>2. é¥®é£Ÿè®°å½•</h2>
        <div class="input-group">
            <input type="text" id="food-name" placeholder="åƒäº†ä»€ä¹ˆï¼Ÿ(å¦‚: ç›–é¥­)" oninput="autoMatch()">
            <div id="smart-hint" class="hint"></div>
            <input type="number" id="food-cal" placeholder="çƒ­é‡ (kcal)" style="margin-top:5px;">
        </div>
        <button class="btn" onclick="addFood()">æ·»åŠ è®°å½•</button>
        
        <div id="food-list" style="margin-top:20px;"></div>
        
        <button onclick="clearDay()" style="width:100%; margin-top:20px; background:transparent; border:1px solid #ddd; color:#999; padding:10px; border-radius:8px;">æ¸…ç©ºä»Šæ—¥è®°å½•</button>
    </div>

<script>
    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. åˆå§‹åŒ–æ•°æ®ç»“æ„
    let userProfile = { height: '', weight: '', age: '', goal: 0 };
    let dietData = { consumed: 0, foods: [] };
    
    // é£Ÿç‰©åº“
    const foodDB = {
        "ç±³é¥­": 230, "ç›–æµ‡é¥­": 750, "é¢": 400, "é¸¡è›‹": 80, 
        "å¯ä¹": 140, "å¥¶èŒ¶": 450, "æ‹¿é“": 200, "ç¾å¼": 15,
        "è‹¹æœ": 50, "é¸¡èƒ¸è‚‰": 130, "æ±‰å ¡": 550, "ç«é”…": 1000
    };

    // 2. é¡µé¢åŠ è½½æ—¶ï¼šè‡ªåŠ¨è¯»æ¡£
    window.onload = function() {
        loadData();
    };

    // 3. è¯»æ¡£å‡½æ•°
    function loadData() {
        // è¯»å–èº«ä½“æ•°æ®
        const savedProfile = localStorage.getItem('myDietProfile_v3');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            document.getElementById('height').value = userProfile.height;
            document.getElementById('weight').value = userProfile.weight;
            document.getElementById('age').value = userProfile.age;
            document.getElementById('goal').value = userProfile.goal;
        }

        // è¯»å–é¥®é£Ÿè®°å½•
        const savedDiet = localStorage.getItem('myDietData_v3');
        if (savedDiet) {
            dietData = JSON.parse(savedDiet);
        }

        updateUI(); // åˆ·æ–°ç•Œé¢
    }

    // 4. å­˜æ¡£å‡½æ•° (ä»»ä½•ä¿®æ”¹éƒ½ä¼šè°ƒç”¨å®ƒ)
    function saveAll() {
        localStorage.setItem('myDietProfile_v3', JSON.stringify(userProfile));
        localStorage.setItem('myDietData_v3', JSON.stringify(dietData));
        updateUI();
    }

    // 5. ä¿å­˜èº«ä½“è®¾ç½® & è®¡ç®—ç›®æ ‡
    function saveProfile() {
        userProfile.height = document.getElementById('height').value;
        userProfile.weight = document.getElementById('weight').value;
        userProfile.age = document.getElementById('age').value;
        userProfile.goal = document.getElementById('goal').value;
        saveAll();
    }

    // è®¡ç®— TDEE
    function calculateTarget() {
        const h = parseInt(userProfile.height);
        const w = parseInt(userProfile.weight);
        const a = parseInt(userProfile.age);
        if(!h || !w || !a) return 0;
        
        // ç®€åŒ–ç‰ˆå…¬å¼
        const bmr = (10 * w) + (6.25 * h) - (5 * a) + 5;
        const tdee = Math.round(bmr * 1.375); // é»˜è®¤è½»åº¦æ´»åŠ¨
        return tdee + parseInt(userProfile.goal);
    }

    // 6. æ™ºèƒ½åŒ¹é…
    function autoMatch() {
        const val = document.getElementById('food-name').value;
        const hintEl = document.getElementById('smart-hint');
        const calEl = document.getElementById('food-cal');
        
        if (!val) { hintEl.innerText = ''; return; }

        for (let key in foodDB) {
            if (val.includes(key)) {
                hintEl.innerText = `ğŸ’¡ çŒœä½ æ˜¯: ${key} (${foodDB[key]} kcal)`;
                if(!calEl.value) calEl.value = foodDB[key];
                return;
            }
        }
        hintEl.innerText = '';
    }

    // 7. æ·»åŠ é£Ÿç‰©
    function addFood() {
        const name = document.getElementById('food-name').value;
        const cal = parseInt(document.getElementById('food-cal').value);
        
        if(!name || isNaN(cal)) { alert("è¯·è¾“å…¥å®Œæ•´å“¦"); return; }

        dietData.consumed += cal;
        dietData.foods.unshift({ id: Date.now(), name: name, cal: cal }); // åŠ åˆ°æœ€å‰é¢
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('food-name').value = '';
        document.getElementById('food-cal').value = '';
        document.getElementById('smart-hint').innerText = '';
        
        saveAll(); // ç«‹å³ä¿å­˜ï¼
    }

    // 8. åˆ é™¤é£Ÿç‰©
    function removeFood(id) {
        const idx = dietData.foods.findIndex(f => f.id === id);
        if (idx > -1) {
            dietData.consumed -= dietData.foods[idx].cal;
            dietData.foods.splice(idx, 1);
            saveAll(); // ç«‹å³ä¿å­˜ï¼
        }
    }
    
    // 9. æ¸…ç©º
    function clearDay() {
        if(confirm("ç¡®å®šæ¸…ç©ºä»Šå¤©æ‰€æœ‰è®°å½•å—ï¼Ÿ")) {
            dietData.consumed = 0;
            dietData.foods = [];
            saveAll();
        }
    }

    // 10. ç•Œé¢æ›´æ–°
    function updateUI() {
        const target = calculateTarget();
        const remaining = target - dietData.consumed;
        
        document.getElementById('target-display').innerText = target;
        document.getElementById('show-consumed').innerText = dietData.consumed;
        
        const remainEl = document.getElementById('show-remaining');
        remainEl.innerText = remaining;
        remainEl.style.color = remaining < 0 ? '#ff4d4f' : '#07c160';

        // è¿›åº¦æ¡
        const pct = target > 0 ? Math.min((dietData.consumed / target) * 100, 100) : 0;
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('progress-bar').style.backgroundColor = remaining < 0 ? '#ff4d4f' : '#07c160';

        // æ¸²æŸ“åˆ—è¡¨
        const list = document.getElementById('food-list');
        list.innerHTML = '';
        dietData.foods.forEach(f => {
            list.innerHTML += `
                <div class="list-item">
                    <span>${f.name}</span>
                    <div style="display:flex; align-items:center;">
                        <span style="font-weight:bold; margin-right:10px;">${f.cal}</span>
                        <span class="del-btn" onclick="removeFood(${f.id})">Ã—</span>
                    </div>
                </div>
            `;
        });
    }
</script>
</body>
</html>